# Pygame ↔ ComfyUI Runner
Readme-Generated by GPT-5... so you know mileage may vary (I was too lazy to fact check all of it).

A tiny Pygame front‑end for firing **ComfyUI** workflows and previewing the results — images on screen, text as an overlay, audio playback, and video saved to disk. Works locally today and is tunnel/host‑ready tomorrow.

---

## Features

- **Paste‑to‑load**: Press **Ctrl+V** to paste a ComfyUI **Save (API Format)** workflow JSON directly into the app. No files required.
- **Token‑based inputs**: Use `%%PROMPT%%` anywhere in your workflow’s text fields. The app replaces it with what you type inside Pygame.  
  Seeds: include `%%SEED%%` *or* let the app auto‑randomize every `seed`/`noise_seed` each run.
- **Artifact harvester**: Collects whatever your graph saves — **images, text, audio, video** — by reading ComfyUI’s `/history` and downloading via `/view`.
- **Non‑blocking game loop**: Workflow runs on a worker thread; your UI stays smooth.
- **Tunnel/host ready**: Point `COMFY_BASE_URL` to an ngrok URL or a reverse‑proxied host; optional Basic Auth supported.
- **Portable across graphs**: No hardcoded node IDs needed; tokens and auto‑seed keep it flexible as you rearrange nodes.

---

## Requirements

- **Python** 3.10+ (3.8+ likely fine, but 3.10+ recommended)
- **ComfyUI** running and reachable (default: `http://127.0.0.1:8188`)
- **Pip packages**: `pygame`, `requests`, `pyperclip`
- **Linux clipboard backend** (for paste): install one of `xclip`, `xsel`, or `wl-clipboard`

```bash
# Create & activate a venv (optional, recommended)
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

# Install deps
pip install pygame requests pyperclip
# Linux clipboard helpers (choose one)
sudo apt install xclip     # or: sudo apt install xsel
# Wayland:
sudo apt install wl-clipboard
```

> If you prefer not to use the clipboard, you can load a workflow from disk by setting `WORKFLOW_PATH` in `main.py`.

---

## Quick Start

1. **Run ComfyUI** locally (or via tunnel/host).  
2. **Start the app**:
   ```bash
   python main.py
   ```
3. In ComfyUI, **Workflow → Save (API Format)**. Copy the **JSON text** to your clipboard.  
4. In the app:
   - **Ctrl+V** to paste the workflow
   - **T** to type your prompt, then **Enter** to finish typing
   - **F5** to run the workflow

**Outputs**  
- **Images** are displayed in the window (auto‑scaled to fit).  
- **Text** files show as a short overlay excerpt.  
- **Audio** (e.g. `.wav`, `.ogg`) plays via `pygame.mixer` (MP3 depends on your SDL build).  
- **Video** (`.mp4`, `.webm`, etc.) is saved to a temp file; its path is shown on screen.

---

## Configure for tunnels or hosting

The client reads `COMFY_BASE_URL` and supports optional Basic Auth if you front ComfyUI with Nginx/Caddy.

```bash
# Example (ngrok)
export COMFY_BASE_URL="https://<your-ngrok-id>.ngrok.io"

# Example (reverse proxy + Basic Auth)
export COMFY_BASE_URL="https://imgbox.yourdomain.com"
# Then in code, initialize with auth=("user","pass") if needed (see comfy_client.py)
```

**Security tip:** Don’t expose ComfyUI directly to the internet. Terminate TLS at a reverse proxy and add authentication and rate limiting.

---

## Make Your Graph “Token‑Aware” (what the app expects)

You don’t need to restructure your graphs — just these light conventions:

1. **Export in API format**  
   In ComfyUI, use **Workflow → Save (API Format)**. Paste that JSON into the app (Ctrl+V) or save it to a file.

2. **Put `%%PROMPT%%` anywhere you want runtime text**  
   - Positive prompt (e.g., CLIPTextEncode `text` field)  
   - Negative prompt  
   - Any text field at all  
   Every `%%PROMPT%%` is replaced with the prompt you typed in the app.

3. **Seeds**  
   - Option A (explicit): set your sampler’s `seed` to the string `%%SEED%%`. The app replaces it with a fresh random 32‑bit int each run.  
   - Option B (implicit): **don’t** add `%%SEED%%`. The app automatically writes a fresh random seed into **every** `seed`/**`noise_seed`** input it finds.  
   - The “randomize after generate” UI toggle in ComfyUI doesn’t affect API runs; rely on the app’s seed logic.

4. **Save your outputs**  
   Ensure your graph ends with the appropriate **Save** nodes so the app can fetch results:
   - **Save Image** → images preview in‑app
   - **Save Text** → shows excerpt overlay
   - **Save Audio** → plays in‑app (codec permitting)
   - **Save Video** → file saved; path printed on screen

That’s it — no node IDs, no schema magic. Tokens + Save nodes make your graphs portable.

---

## How to Use the App (controls)

- **Ctrl+V**: Paste API‑format workflow JSON from clipboard
- **T**: Enter prompt typing mode
  - **Enter**: finish typing (keeps the text)
  - **Esc**: cancel/clear prompt
- **F5**: Run the current workflow (injects `%%PROMPT%%`, sets seed, starts worker)
- Status, last seed, and saved video paths are displayed on screen.

**File‑based fallback**  
If you prefer files over clipboard:
- Save your API JSON as `my_comfy_workflow.json`
- Set `WORKFLOW_PATH` in `main.py` to that path
- Press **F5** to run

---

## Troubleshooting

- **“Paste failed: pyperclip could not find a copy/paste mechanism”**  
  Install `xclip`, `xsel`, or `wl-clipboard` (Linux). On macOS/Windows this usually works out of the box.

- **No outputs appear**  
  Confirm your graph has **Save** nodes and that ComfyUI is reachable at `COMFY_BASE_URL` (or `127.0.0.1:8188` by default).

- **Audio won’t play**  
  Some SDL builds lack MP3 support. Use WAV/OGG, or convert your output format in ComfyUI.

- **Still using the same seed every run**  
  Make sure you added the seed patch: the app either replaces `%%SEED%%` or auto‑sets `seed`/`noise_seed` across nodes each run.

---

## Project Layout

```
main.py           # Pygame UI and controls (paste, type, run, preview)
comfy_client.py   # HTTP client: submit workflow, poll history, download artifacts
params.py         # Token replacement, seed helpers (%%PROMPT%%, %%SEED%%, auto‑seed)
loader.py         # Optional file‑based loader and node param setter
```

---

## Important Final Note:

Additionally there are 2 sample workflows provided. The samples aren't exactly plug-and-play because the the models I use are placed into a folder based off of base model in this case SDXL/juggernautXL_ragnarokBy.safetensors <- You will obviously need to hook your own model and path up.
